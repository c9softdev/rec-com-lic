<div class="login-container">
  <div class="row g-0 w-100 auth-card">
    <!-- Left: Branding -->
    <div class="col-lg-6 brand-section">
      @if (configLoading) {
        <div class="text-muted">Loading...</div>
      } @else {
        @if (config) {
          <img *ngIf="config.var_logo_client" [src]="config.var_logo_client" alt="Client Logo" class="client-logo">
          <img *ngIf="config.var_logo_url" [src]="config.var_logo_url" alt="Company Logo" class="company-logo">
        }
      }
    </div>

    <!-- Right: Login / Forgot -->
    <div class="col-lg-6 form-section">
      <div class="text-center mb-1">
        <h1 class="fw-bold text-white text-uppercase mb-2">{{ forgotMode ? 'FORGOT PASSWORD' : 'LOGIN' }}</h1>
        <div class="text-white-50 text-uppercase">{{ config?.var_title || 'Loading...' }}</div>
      </div>

      @if (!forgotMode) {
        <form [formGroup]="loginForm" (ngSubmit)="onSubmit()">
          @if (error) {
            <div class="error-message">{{ error }}</div>
          }
          @if (!error) {
            @if (step === 1 && usernameSubmitted && loginForm.get('username')?.invalid) {
              <div class="error-message">
                @if (loginForm.get('username')?.errors?.['required']) { <span>User name is required.</span> }
                @if (loginForm.get('username')?.errors?.['minlength']) { <span>Minimum 3 characters.</span> }
                @if (loginForm.get('username')?.errors?.['maxlength']) { <span>Maximum 30 characters.</span> }
              </div>
            }
            @if (step === 2 && passwordSubmitted && loginForm.get('password')?.invalid) {
              <div class="error-message">
                @if (loginForm.get('password')?.errors?.['required']) { <span>Password is required.</span> }
                @if (loginForm.get('password')?.errors?.['minlength']) { <span>Minimum 6 characters.</span> }
                @if (loginForm.get('password')?.errors?.['maxlength']) { <span>Maximum 32 characters.</span> }
              </div>
            }
          }

          @if (step === 1) {
            <div class="mb-3">
              <input type="text" class="form-control form-control-lg" placeholder="Enter User Name *" formControlName="username" #usernameInput [appAutoFocus]="step === 1" [class.is-invalid]="loginForm.get('username')?.touched && loginForm.get('username')?.invalid">
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <a href="javascript:void(0)" (click)="toggleForgotMode()" class="text-white text-decoration-none">Forgot Password?</a>
              <button type="submit" class="btn btn-light btn-lg" [disabled]="loginForm.get('username')?.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                {{ loading ? 'Loading...' : 'Next' }}
              </button>
            </div>
          } @else {
            <div class="mb-3">
              <input type="password" class="form-control form-control-lg" placeholder="Enter Password *" formControlName="password" #passwordInput [appAutoFocus]="step === 2" [class.is-invalid]="loginForm.get('password')?.touched && loginForm.get('password')?.invalid">
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <button type="button" class="btn btn-outline-light btn-lg" (click)="backToUsername()">Back</button>
              <button type="submit" class="btn btn-light btn-lg" [disabled]="loginForm.get('password')?.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                {{ loading ? 'Loading...' : 'Login' }}
              </button>
            </div>
            <div class="text-center mt-3">
              <a href="javascript:void(0)" (click)="toggleForgotMode()" class="text-white-50 text-decoration-none">Forgot password?</a>
            </div>
          }
        </form>
      }

      @if (forgotMode) {
        <form [formGroup]="forgotForm" (ngSubmit)="onForgotSubmit()">
          @if (error) {
            <div class="error-message">{{ error }}</div>
          }
          @if (successMessage) {
            <div class="alert alert-success text-dark py-2 mb-3" role="alert">{{ successMessage }}</div>
          }
          @if (!error && !successMessage && forgotForm.get('email')?.touched && forgotForm.get('email')?.invalid) {
            <div class="error-message">
              @if (forgotForm.get('email')?.errors?.['required']) { <span>Email is required.</span> }
              @if (forgotForm.get('email')?.errors?.['email']) { <span>Enter a valid email address.</span> }
            </div>
          }

          <div class="mb-3">
            <input type="email" class="form-control form-control-lg" placeholder="Enter Email Address *" formControlName="email" [appAutoFocus]="true" [class.is-invalid]="forgotForm.get('email')?.touched && forgotForm.get('email')?.invalid">
          </div>
          <div class="d-flex justify-content-center my-3 recaptcha-wrapper">
            <re-captcha [siteKey]="recaptchaSiteKey" (resolved)="onRecaptchaResolved($any($event))"></re-captcha>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-outline-light btn-lg" (click)="toggleForgotMode()">Back to Login</button>
            <button type="submit" class="btn btn-light btn-lg" [disabled]="forgotForm.get('email')?.invalid || !recaptchaVerified || loading">
              <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
              {{ loading ? 'Processing...' : 'Reset Password' }}
            </button>
          </div>
        </form>
      }
    </div>
  </div>
</div>
